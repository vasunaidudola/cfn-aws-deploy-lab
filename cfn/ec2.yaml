AWSTemplateFormatVersion: '2010-09-09'
Description: EC2 instance in exported VPC/Subnet (installs Nginx)

Parameters:
  ExportPrefix:
    Type: String
    Default: labdemo
  InstanceType:
    Type: String
    Default: t3.micro
  AmiSsmParam:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64

Resources:
  SecGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP (80) from anywhere (lab)
      VpcId: !ImportValue
        'Fn::Sub': '${ExportPrefix}-VpcId'
      SecurityGroupIngress:
        - { IpProtocol: tcp, FromPort: 80, ToPort: 80, CidrIp: 0.0.0.0/0 }

  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref AmiSsmParam
      InstanceType: !Ref InstanceType
      SubnetId: !ImportValue
        'Fn::Sub': '${ExportPrefix}-PublicSubnetId'
      SecurityGroupIds: [!Ref SecGroup]
      UserData:
        'Fn::Base64': !Sub |
          #!/bin/bash
          dnf update -y
          dnf install -y nginx
          echo "<h1>Deployed via CloudFormation + GitHub Actions</h1>" > /usr/share/nginx/html/index.html
          systemctl enable nginx
          systemctl start nginx
      Tags:
        - { Key: Name, Value: cfn-lab-ec2 }

Outputs:
  InstanceId: { Value: !Ref EC2Instance }
  PublicIP:    { Value: !GetAtt EC2Instance.PublicIp }
  Url:         { Value: !Sub 'http://${EC2Instance.PublicIp}' }
